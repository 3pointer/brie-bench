#! /bin/bash

set -eu

if ! source bin/utils.sh; then
    echo "failed to load the utils package. make sure bin/utils.sh exists"
    exit 1
fi
cluster_id=${1-$(get_cluster)}
if [ $cluster_id = '.' ]; then
  cluster_id=`get_last_cluster`
fi

key=$(mc ls --json minio/artifacts/$cluster_id | jq -r ".key")
if [ $(echo "$key" | wc -l) -gt 1 ]; then
  select k in $key; do
    key=k
    break
  done
fi

if [ ${2-""} ]; then
  mc cat minio/artifacts/$cluster_id/${key}${2}
else
  files=$(mc ls --json minio/artifacts/$cluster_id/${key} | jq -r ".key")
  if [ ! "$files" ]; then
    fail "no file found in cluster $cluster_id"
  fi
  log "select file (^D aka EOF to exit): "
  select file in $files; do
    mc cat minio/artifacts/$cluster_id/${key}${file} | less
    break
  done
fi
