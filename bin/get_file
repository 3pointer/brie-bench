#! /bin/bash

set -eu

if ! source bin/utils.sh; then
    echo "failed to load the utils package. make sure bin/utils.sh exists"
    exit 1
fi

select_file() {
  path=$1
  files=$(mc ls --json "$path" | jq -r ".key")
  if [ ! "$files" ]; then
    fail "no file found in cluster $cluster_id (the bench hasn't done yet?)"
  fi
  echo "$GREEN_FONT[$path]$RESET_FONT select file: "
  select file in $files; do
    if [ "$(mc stat --json $(echo "${path}${file}" | sed -E 's/\/$//') | jq -r .type)" != 'file' ]; then
      select_file "${path}${file}"
      return $?
    fi
    mc cat "${path}${file}" | less
    break
  done
}

cluster_id=${1-$(get_cluster)}
if [ $cluster_id = '.' ]; then
  cluster_id=`get_last_cluster`
fi

key=$(mc ls --json minio/artifacts/$cluster_id | jq -r ".key")
if [ $(echo "$key" | wc -l) -gt 1 ]; then
  select k in $key; do
    key=k
    break
  done
fi

if [ ${2-""} ]; then
  mc cat minio/artifacts/$cluster_id/${key}${2}
else
  select_file "minio/artifacts/$cluster_id/${key}"
fi
