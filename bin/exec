#! /bin/bash

if ! source workload/utils.sh; then
    echo "failed to load the utils package. make sure workload/utils.sh exists"
    exit 1
fi

parse_args $@

set -eu

if [ ! $component ]; then
    show_help
    fail "must provide a component name"
fi

log component = $component
log hash = ${hash-"default"}
log workload = ${workload-"default"}
basic_json=`echo '{
    "cluster_request": {
        "name": "br_version",            
        "version": "nightly"
    },
    "cluster_request_topologies": [
        {"component": "tidb", "deploy_path": "/data1", "rri_item_id": 1}, 
        {"component": "pd", "deploy_path": "/data1", "rri_item_id": 1}, 
        {"component": "tikv", "deploy_path": "/data1", "rri_item_id": 2}, 
        {"component": "tikv", "deploy_path": "/data1", "rri_item_id": 3}, 
        {"component": "tikv", "deploy_path": "/data1", "rri_item_id": 4}, 
        {"component": "prometheus", "deploy_path": "/data1", "rri_item_id": 1}, 
        {"component": "grafana", "deploy_path": "/data1", "rri_item_id": 1}
    ],
    "cluster_workload": {        
        "type": "standard",               
        "docker_image": "lovecsust/brie-bench:latest",
        "cmd": "./run.sh",
        "args": [],
        "rri_item_id": 1,                      
        "artifact_dir": "/artifacts",
        "env": {}
    }
}' | jq ".cluster_workload.args+=[\"$component\"]"`

if [ ${hash-""} ]; then
    basic_json=`echo $basic_json | jq ".cluster_workload.args+=[\"-h\", \"$hash\"]"`
fi
if [ ${workload-""} ]; then
    basic_json=`echo $basic_json | jq ".cluster_workload.args+=[\"-w\", \"$workload\"]"`
fi

log running with request
log $basic_json

curl 172.16.5.110:8000/api/cluster/test -XPOST -d "$basic_json"

set +eu